-- Procedimiento para cargar los almacenes a todos los articulos de Materias Primas.
-- Desarrollo: Ing. Vicente Cueva Ram�rez.
-- Actualizado: Miercoles 28 de Noviembre del 2018.
-- Actualizado: Viernes 13 de Diciembre del 2019; Modificar Almacenes y volver a Cargar.

Use ItekniaDB
Go
--Declaraci�n de Variables
Declare @CodArt uniqueidentifier
Declare @Code	varchar(20)
Declare @Nombre varchar(200)
Declare @Reg	integer

--Parametros Fecha Inicial y Fecha Final
--Set @CodArt = 'DF9CE126-1295-4247-8CDB-D4389F42FF2C'

-- Tipo de Articulos.
/*
Relacion de Tipos de Articulos Vigentes

Select distinct ART_ATP_TipoId, ATP_Descripcion
from Articulos
inner join ArticulosTipos on ART_ATP_TipoId=ATP_TipoId
where ART_Activo = 1 AND ART_Eliminado = 0

ART_ATP_TipoId	ATP_Descripcion
56B66D49-FE82-4414-A7E8-43F3916572D3	Subensamble fabricado
8418208F-EC34-41E8-9802-83B4404764DA	Materia prima
15185803-A98F-4757-8CD5-845EA0492254	Consignado valor contable
84F680E5-C596-45DE-971B-8DE7AA565123	Consignado valor no contable
0D0B9D8A-C779-4D11-8CF6-C1DA16E4334C	P.T Fabricado

Relacion de Articulos que no tienen cargado ninguna localidad.

Select ART_ArticuloId, ART_CodigoArticulo, ART_Nombre,
(Select COUNT(ARL_ART_ArticuloId) from ArticulosLocalidades Where ARL_ART_ArticuloId=ART_ArticuloId AND ARL_Eliminado = 0) AS REG 
from Articulos
where ART_Activo = 1 AND ART_Eliminado = 0 AND ART_ATP_TipoId = '8418208F-EC34-41E8-9802-83B4404764DA'
and (Select COUNT(ARL_ART_ArticuloId) from ArticulosLocalidades Where ARL_ART_ArticuloId=ART_ArticuloId) = 0
order by ART_CodigoArticulo

--Relacion de Localidades activas a la fecha.

Select LOC_ALM_AlmacenId, LOC_LocalidadId,  LOC_CodigoLocalidad, LOC_Nombre
from Localidades
where LOC_Eliminado = 0 and LOC_LocalidadGeneral = 0
and LOC_ALM_AlmacenId = '0B2FFBB7-44A4-485F-A2D4-792E281591E5'
Order By LOC_Nombre

Select *
from Localidades
where LOC_Eliminado = 0 and LOC_LocalidadGeneral = 0
Order By LOC_Nombre



LOC_LocalidadId	LOC_ALM_AlmacenId	LOC_Nombre
49D778C5-BF1C-4683-A9B5-46DB602862C8	CB35B14B-7BB1-4771-84DA-A4CBE159C8D6	1 ALMACEN MATERIAS PRIMAS
0547A9FC-4919-459E-920B-15A9A09882AD	CB35B14B-7BB1-4771-84DA-A4CBE159C8D6	1 MATERIALES OBSOLETOS.
FBD2F12B-06D8-41C0-AD09-94BE9309FAF8	1287E5E7-212B-4240-AD18-25A486D95A5E	2 AZARET
667B423F-5091-4DD6-9242-38574C14EA3E	C0138CFF-C57E-401D-BFE4-05C4188732B9	2 CARPINTERIA
BFBCD7D7-0596-45BB-BC03-B4ADE69364E4	A3ECCB9D-13E6-4942-9EF1-0C64CECAB672	2 CONTROL PRODUCCION
34EDC394-529F-4EAE-9761-E12C4D838EDE	B43FAD82-AF04-4CA8-AB7F-C09FA8C445A1	2 FUNDAS Y TAPIZADOS
44E06110-481D-49CD-A856-35BCC466694B	18D1381D-538B-4CD6-A180-27D121E997D0	2 HULE ESPUMA
064641A3-91D9-44C1-AC60-F31C01BE8952	24FC325C-73DB-42D1-B697-BC933B9C9D4B	2 LACA
B5BC67A7-7247-4487-86AC-115E453A8288	09D3B12E-135C-4C68-ABE4-BC92769F17ED	2 MADERAS Y DERIVADOS
38173D61-BB28-49B8-A71F-F12D15ACEE53	6D5D3EB9-8E1B-42AA-A11A-FA0040BE328D	2 MANTENIMIENTO
8CF3C457-7DCD-488E-88AB-CEF6879B0592	6073609B-C09A-4C0E-A3AF-A4116B1CECEF	2 METALMEX
8DCEC3E4-B9C1-4014-9643-5B777473576C	DCC5A0E6-3FA4-4C23-B48E-A120D5B2F6B8	2 VALLARTA
62EAAF01-1020-4C75-9503-D58B07FFC6EF	0B2FFBB7-44A4-485F-A2D4-792E281591E5	3 ALMACEN DE PRODUCTO TERMINADO


85855769-2785-4B24-AA54-B6691CF90F8A	CB35B14B-7BB1-4771-84DA-A4CBE159C8D6	X NO USAR.

*/
-- Articulos que no tienen Registros en ArticulosLocalidades, cargar todas las localidades.
Declare ARLCursor CURSOR GLOBAL

FOR Select ART_ArticuloId, ART_CodigoArticulo, ART_Nombre,
(Select COUNT(ARL_ART_ArticuloId) from ArticulosLocalidades Where ARL_ART_ArticuloId=ART_ArticuloId AND ARL_Eliminado = 0) AS REG 
from Articulos
where ART_Activo = 1 AND ART_Eliminado = 0 AND ART_ATP_TipoId = '8418208F-EC34-41E8-9802-83B4404764DA'
and (Select COUNT(ARL_ART_ArticuloId) from ArticulosLocalidades Where ARL_ART_ArticuloId=ART_ArticuloId) = 0
order by ART_CodigoArticulo

OPEN ARLCursor
FETCH ARLCursor into @CodArt, @Code, @Nombre, @Reg
While(@@FETCH_STATUS = 0)
Begin
If @Reg = 0 
	
INSERT INTO [dbo].[ArticulosLocalidades]
           ([ARL_ArticuloLocalidadId]
           ,[ARL_LOC_LocalidadId]
           ,[ARL_ALM_AlmacenId]
           ,[ARL_ART_ArticuloId]
		   ,[ARL_Eliminado]
		   ,[ARL_FechaUltimaModificacion]
		   ,[ARL_EMP_ModificadoPorId]) 
  VALUES
	(NEWID(), '49D778C5-BF1C-4683-A9B5-46DB602862C8', 'CB35B14B-7BB1-4771-84DA-A4CBE159C8D6', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179'),
	(NEWID(), '0547A9FC-4919-459E-920B-15A9A09882AD', 'CB35B14B-7BB1-4771-84DA-A4CBE159C8D6', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179'),
	(NEWID(), 'FBD2F12B-06D8-41C0-AD09-94BE9309FAF8', '1287E5E7-212B-4240-AD18-25A486D95A5E', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179'),
	(NEWID(), '667B423F-5091-4DD6-9242-38574C14EA3E', 'C0138CFF-C57E-401D-BFE4-05C4188732B9', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179'),
	(NEWID(), 'BFBCD7D7-0596-45BB-BC03-B4ADE69364E4', 'A3ECCB9D-13E6-4942-9EF1-0C64CECAB672', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179'),
	(NEWID(), '34EDC394-529F-4EAE-9761-E12C4D838EDE', 'B43FAD82-AF04-4CA8-AB7F-C09FA8C445A1', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179'),
	(NEWID(), '44E06110-481D-49CD-A856-35BCC466694B', '18D1381D-538B-4CD6-A180-27D121E997D0', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179'),
	(NEWID(), '064641A3-91D9-44C1-AC60-F31C01BE8952', '24FC325C-73DB-42D1-B697-BC933B9C9D4B', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179'),
	(NEWID(), 'B5BC67A7-7247-4487-86AC-115E453A8288', '09D3B12E-135C-4C68-ABE4-BC92769F17ED', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179'),
	(NEWID(), '38173D61-BB28-49B8-A71F-F12D15ACEE53', '6D5D3EB9-8E1B-42AA-A11A-FA0040BE328D', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179'),
	(NEWID(), '8CF3C457-7DCD-488E-88AB-CEF6879B0592', '6073609B-C09A-4C0E-A3AF-A4116B1CECEF', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179'),
	(NEWID(), '8DCEC3E4-B9C1-4014-9643-5B777473576C', 'DCC5A0E6-3FA4-4C23-B48E-A120D5B2F6B8', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179'),
	(NEWID(), '62EAAF01-1020-4C75-9503-D58B07FFC6EF', '0B2FFBB7-44A4-485F-A2D4-792E281591E5', @CodArt, 0, GETDATE(), 'D117CCA7-7114-4B55-9EEB-9F8553BF6179')
Else
	If @Reg = 0 
		print 'Para Cargar Registros... ' + @Code + ' ' + @Nombre + ' ' + Str(@Reg)
	Else
		print 'Brinco Registro NO CARGA ' + @Code + ' ' + @Nombre + ' ' + Str(@Reg);

FETCH ARLCursor into @CodArt, @Code, @Nombre, @Reg
end
close ARLCursor
deallocate ARLCursor
Go



Select *
from Localidades
where LOC_Eliminado = 0 --and LOC_LocalidadGeneral = 0
Order By LOC_Nombre

Select * from Articulos Where ART_LOC_LocPredEntradasId = 'bcc35f23-6a19-41f8-b6e8-8b5d1ad89b80'

Select * from Articulos Where ART_LOC_LocPredSalidasId = 'bcc35f23-6a19-41f8-b6e8-8b5d1ad89b80'

Select * from Articulos Where ART_CodigoArticulo = '13331'
d4ff91b0-97ca-47b3-b262-39f3b898a256

-- Update Localidades set LOC_Eliminado = 1 Where LOC_LocalidadId =  'bcc35f23-6a19-41f8-b6e8-8b5d1ad89b80'

